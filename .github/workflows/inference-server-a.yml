# Generated by Claude Code -- 2026-02-13
name: Inference Server A

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  DURATION_SECONDS: 18000  # 5 hours
  HANDOFF_BUFFER: 360      # 6 minutes before expiry

jobs:
  serve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-inference.txt

      - name: Install dependencies
        run: pip install -r requirements-inference.txt

      - name: Download models from HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import snapshot_download
          snapshot_download(
              'DominicTanzillo/panacea-models',
              local_dir='models',
              allow_patterns=['*.json', '*.pkl', '*.pt'],
              token='$HF_TOKEN' if '$HF_TOKEN' else None,
          )
          print('Models downloaded successfully')
          " || echo "HF download failed — using local models if available"

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: Start server
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          SERVER_PID=$!

          # Wait for server to be ready
          for i in $(seq 1 60); do
            if curl -s http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Server ready after ${i}s"
              break
            fi
            sleep 1
          done

          # Start Cloudflare tunnel
          ./cloudflared tunnel --url http://localhost:8000 --no-autoupdate > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          sleep 5

          # Extract tunnel URL
          TUNNEL_URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' tunnel.log | head -1)
          echo "Tunnel URL: $TUNNEL_URL"

          if [ -z "$TUNNEL_URL" ]; then
            echo "ERROR: Failed to get tunnel URL"
            cat tunnel.log
            exit 1
          fi

          # Write tunnel URL to git notes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
          git fetch origin "refs/notes/*:refs/notes/*" 2>/dev/null || true
          git notes add -f -m "$TUNNEL_URL" "$FIRST_COMMIT"
          git push origin "refs/notes/*" --force

          echo "Published tunnel URL to git notes: $TUNNEL_URL"

          # Run until duration expires
          START=$(date +%s)
          while true; do
            ELAPSED=$(( $(date +%s) - START ))
            REMAINING=$(( DURATION_SECONDS - ELAPSED ))

            if [ $REMAINING -le $HANDOFF_BUFFER ]; then
              echo "Approaching timeout ($REMAINING s remaining) — triggering Server B"

              # Trigger Server B
              gh workflow run inference-server-b.yml
              sleep 30

              echo "Shutting down Server A"
              kill $SERVER_PID $TUNNEL_PID 2>/dev/null || true
              exit 0
            fi

            # Health check
            if ! curl -s http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Server health check failed — restarting"
              kill $SERVER_PID 2>/dev/null || true
              uvicorn app.main:app --host 0.0.0.0 --port 8000 &
              SERVER_PID=$!
              sleep 5
            fi

            sleep 30
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DURATION_SECONDS: ${{ env.DURATION_SECONDS }}
          HANDOFF_BUFFER: ${{ env.HANDOFF_BUFFER }}
